<#assign comps = _SvcComponent.getAll()>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="includes/styles/link.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="includes/3rd/prototype/prototype.js"></script> 
<script src="includes/scripts/loader.js?load=server,cookie,event,common" type="text/javascript"></script>
<script>

function init() {
	systeminfo();
	window.setInterval(systeminfo, 20000);
	<#if _IsEventNoticeEnabled()>
	EventObserver.addListener("/event/notice/status", turnEventNotice);
	</#if>
	EventObserver.addListener("/frameset/bottom/reload", function(){
		document.location.reload();
	});
	turnEventNotice({disabled : Cookie.get('/event/notice/disabled') == 'true'});
	
}

function showEventNotice(force) {
	Collapsar.publish("/event/event/notice", {force : force});
}

function systeminfo() {
	var url = "misc/systeminfo.fhtml";	
	new Ajax.Request(url, {
		method : 'post',
		onSuccess : function(t) {
		   EvalXmlHttp(t, function(js){
				if (js.result == 'success') {
	         		$('timer_bar').innerHTML = js.context.time
					$('memUsed').innerHTML = js.context.memUsed;
					$('diskUsed').innerHTML = js.context.diskUsed;
					$('cpuUsed').innerHTML = js.context.cpuUsed;
					var components = js.context.components;
					for(var c in components) {
						$('comp_status_' + c).src = components[c] ? "includes/icons/connected.gif" : "includes/icons/connecten.gif";
						$('comp_status_' + c).title = components[c] ? "就绪" : "停止";
					}
	            }
			});
	  	}
	});
}

var comp_index = 0;

function shiftUp() {
	
	var max = parseInt(($('comp_pane').clientWidth / 170).toFixed(0));
	comp_index = comp_index - max < 0 ? 0 : comp_index - max;
	for(var i = comp_index; i < ${comps?size}; i++) {
		if ($('comp_' + i)) {
			$('comp_' + i).show();
		}
	}
}

function shiftDown() {
	var max = parseInt(($('comp_pane').clientWidth / 170).toFixed(0));
	comp_index = comp_index + max >= ${comps?size} ? ${comps?size} - max : comp_index + max;
	for(var i = 0; i < comp_index; i++) {
		
		if ($('comp_' + i)) {
			$('comp_' + i).hide();
		}
	}
}

var eventNoticeId;

function turnEventNotice(args) {
	
	var disabled = args.disabled;
	if (disabled) {
		window.clearInterval(eventNoticeId);
	}else{
		eventNoticeId = window.setInterval(showEventNotice, 5 * 60 * 1000);
	}
	Cookie.set('/event/notice/disabled', disabled, 1000000, '/')
	if ($('img_notice')) {
		$('img_notice').src = disabled ? '${base}/includes/icons/volume_mute.gif' : '${base}/includes/icons/volume_on.gif'
		$('img_notice').title = disabled ? '声光告警:关' : '声光告警:开'
	}
}

Event.observe(window, 'load', init);
</script>
</head>
<body style="margin:0;">
<div style="height:22px;overflow-y:hidden;">
	<table cellpadding="0" cellspacing="0" height="22" border="0" background="includes/images/status_bg.gif" width="100%">
		<tr>
			<td style='width:450px;' valign="top">
				<table cellpadding="0" cellspacing="0" border="0" style="font-size:12px;color:#16355e;width:450px;">
					<tr class="cmn_label">
						<td valign="baseline"><img src="includes/images/status_ready.gif" alt="ready"/>&nbsp;</td>
						<td align="center">就绪</td>
						<td ><img src="includes/images/status_dash.gif" alt="dash">&nbsp;</td>
						<td valign="top"><img src="includes/images/status_system.gif"></td>
						<td>［系统状态：CPU load:<span id="cpuUsed">-</span>%，MEM Used:<span id="memUsed">-</span>%，DISK used:<span id="diskUsed">-</span>%］</td>
						<td><img src="includes/images/status_dash.gif">&nbsp;</td>
					</tr>
				</table>
			</td>
			<td class="cmn_label" style='padding-top:3px;' id="comp_pane">
				<#list comps as comp>
				<div style='float:left;width:150px;height:20px' id="comp_${comp_index}">
				<img src="includes/icons/component.gif" align='absmiddle'>${comp.name}&nbsp;<img id="comp_status_${comp.type}" src="includes/icons/${_SvcStatus(comp.type)?string('connected','connecten')}.gif" title="${_SvcStatus(comp.type)?string('就绪x','停止x')}" align='absmiddle'/>
				</div>
				</#list>
			</td>
			<td valign="top" align='right' style='width:20px;'>
			<input type="button" style='background:url(includes/icons/dot_up.gif) no-repeat center center' style="width:20px;height:8px;position:relative;top:-2px" onclick="shiftUp()">
			<input type="button" style='background:url(includes/icons/dot_down.gif) no-repeat center center' style="width:20px;height:8px;position:relative;top:-10px" onclick="shiftDown()">
			</td>
			<#if _IsEventNoticeEnabled()>
			<td align="right" class="cmn_label" style='width:30px' valign="top">
				<img src="includes/images/status_dash.gif" alt="dash">
				<img id="img_notice" src="${base}/includes/icons/volume_on.gif" style='cursor:pointer' onclick='showEventNotice(true)' border='0' title='声光告警:开'>&nbsp;
			</td>
			</#if>
			<td align="right" class="cmn_label" style='width:115px' valign="top">
				<table cellpadding="0" cellspacing="0" border="0" height="22" style='width:115px'>
					<tr class="cmn_label">
						<td valign="top"><img src="includes/images/status_dash.gif"/></td>
						<td valign="top"><img src="includes/images/status_time.gif"/></td>
						<td align="center"><span id="timer_bar">-:-</span></td>
					</tr>
				</table>
			</td>
		
	</table>
</div>
</body>
</html>