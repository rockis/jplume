<#include "common/macros.ftl">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link href="${base}/includes/styles/link.css" rel="stylesheet" type="text/css" />
<link href="${base}/includes/styles/table.css" rel="stylesheet" type="text/css" />
<link href="${base}/includes/styles/form.css" rel="stylesheet" type="text/css" />
<link href="${base}/includes/styles/button.css" rel="stylesheet" type="text/css" />
<link href="${base}/includes/styles/msg.css" rel="stylesheet" type="text/css" />

<script src="includes/3rd/prototype/prototype.js" type="text/javascript"></script>
<script src="includes/scripts/loader.js?load=event,cookie,dialog,form,common" type="text/javascript"></script>
<title>${_About().displayName}</title>
</head>

<script language="javascript">
	var cacheId = null;
	//Open or Close Left Pane
	function oclp(){
		if ($('separator').getAttribute('locked') == true) {
			return;
		}
		var open = $('separator').getAttribute('opened') == 'true';
		if (open) {
			closeLeftPane();
		}else{
			openLeftPane();
		}
	}
	
	function closeLeftPane(){
		$('leftMenu').hide();
		$('separator').setAttribute('opened', 'false');
		$('separator').src = $('separator').getAttribute('closeIcon');
	}
	
	function openLeftPane(){
		$('leftMenu').show();
		$('separator').setAttribute('opened', 'true');
		$('separator').src = $('separator').getAttribute('openIcon');
	}
	
	function lockSeparator(lock) {
		$('separator').setAttribute('locked', lock);
	}
	
	function noleftpane() {
		closeLeftPane();
		lockSeparator(true);
	}
	
	function showleftpane() {
		openLeftPane();
		lockSeparator(false);
	}
	
	function switchLoc(dir) {
		var left = $('leftFrame');
		var main = $('mainFrame');
		left.src = dir + "/main.fhtml";
		main.src = dir + "/default.fhtml";
		showleftpane();
	}
	
	function init() {
		new Dialog.Box('cachecheckdlg');
		new Dialog.Box('aboutdlg');
		new Dialog.Box('copyrightdlg');
		new Dialog.Box('accountmngdlg');
		new Ajax.Form('accountmngForm', {dialog : $('accountmngdlg'), onSuccess : function(){
		}});
		EventObserver.addListener("/account/show",  function(e){
			var pwds = Form.getInputs('accountmngform', 'password');
			for(var i = 0; i < pwds.length; i++) {
				pwds[i].value = "";
			}
			$('accountmngform').clear();
			$('accountmngdlg').show();
		});
		EventObserver.addListener("/help/showabout",  function(e){
			$('aboutdlg').show();
		});
		
		cacheId = cacheCheck();
		var notipcookie = Cookie.get('notipcache') == 'true';
			if (!notipcookie) {
			window.setTimeout(function() {
				var nid = cacheCheck();
				if (cacheId == nid) {
					$('cachecheckdlg').show();
				}
			}, 10);
		}
		
		EventObserver.addListener("/event/event/notice",  showEventNotice);
		$('cb_notice').checked = Cookie.get('/event/notice/disabled') == 'true'
	}
	
	function cacheCheck() {
		var cacheId = null;
		var url = '${base}/misc/cachecheck.fhtml';
		new Ajax.Request(url, {
			method : 'get',
			asynchronous: false,
			onSuccess: function(t) {
				cacheId = t.responseText;
			}
		});
		return cacheId;
	}
	
	var regTable = {};
	
	EventObserver.addListener("/register/write", writeRegister);
	EventObserver.addListener("/register/read", readRegister);
	
	function writeRegister(ctx) {
		regTable[ctx.item] = ctx.content;
	}
	
	function readRegister(ctx){
		ctx.content = regTable[ctx.item];
		if (ctx.remove) {
			delete(regTable[ctx.item]);
		}
	}
	
	//EventObserver.addListener("/event/noleft", noleftpane);
	//EventObserver.addListener("/event/showleft", showleftpane);
	
	Event.observe(window, 'load', init);
	
	var closeEventNoticeId = null;
	function closeEventNotice() {
		$('div_notice').hide();
		$Movie('sound_player').setData();
		window.clearTimeout(closeEventNoticeId);
	}
	
	var eventNoticeDisabled = false;
	var noticeIconClass = { 1 : 'low', 2 : 'middle', 3 : 'high'}
	function showEventNotice(args) {
		var force = args.force;
		new Ajax.Request("${base}/event/notice/show.action", {
			method : 'post',
			onSuccess: function(t) {
				EvalXmlHttp(t, function(c){
					if (c.count == 0 && !force) return;
					$('div_notice_level').className = 'icon ' + noticeIconClass[c.level];
					var msg = '最近' + c.minutes + '分钟共发生告警' + c.count + '件,其中<br/>';
					for (var i = 0; i < c.groups.length; i++) {
						msg = msg + "<a href=\"javascript:showEventNoticeList('" + c.groups[i].name + "')\">" + c.groups[i].name + ": [" + c.groups[i].count + "]件</a><br/>";
						if (i == 3) {
							msg = msg + "<a href='javascript:showEventNoticeList();void(0)'>... ...</a><br/>";
							break;
						}
					}
					$('div_notice_msg').innerHTML = msg;
					$('div_notice').show();
					window.clearTimeout(closeEventNoticeId);
					closeEventNoticeId = window.setTimeout(closeEventNotice, 30 * 1000);
					$('sound_player').show();
					$Movie('sound_player').playSound("${base}/includes/swf/alarm.mp3",1);
				});
			}
		});
	}
	function $Movie(movieName) {
		if (navigator.appName.indexOf("Microsoft") != -1) return window[movieName];
		else return document[movieName];
	}
	
	function showEventNoticeList(gname) {
		if (gname) {
			$('noticeForm').noticeGroupName.value = gname;
		}
		$('noticeForm').noticeGroupName.disabled = gname == null;
		$('noticeForm').submit();
	}
	
	function turnEventNotice(disabled) {
		Collapsar.publish("/event/notice/status", {disabled : disabled});
	}
	
</script>
<style type="text/css">
	.dmenu {
		top: 0px;
		left: 0px;
		z-index: 100;
		position: absolute;
		visibility: hidden;
		border: 1px solid #86837e;
		font:normal 12px Verdana;
		line-height: 18px;
		background-color: #e4e4e4;
		width: 103px;
	}
	
	.dmenu a, .dmenu a:active, .dmenu a:visited {
		color: black;
		width: 100%;
		display: block;
		border-bottom: 1px solid #86837e;
		padding: 1px 0px 0px 0px;
		text-decoration: none;
		text-indent: 5px;
	}
	
	.dmenu a:hover {
		background-color: #6699cc;
		color: black;
	}
</style>

<body style="margin:0;" scroll="no">
	<table border="0" cellspacing="0" cellpadding="0" width="100%" height="100%" style="border-collapse:collapse;">
		<tr height="64">
			<td id="topMenu" valign="top">
				<iframe id="topFrame" src="top.fhtml" width="100%" height="64" allowtransparency="true" style="background-color:#EAF2F5" frameborder="0" scrolling="outo" name="topFrame" title="topFrame"></iframe>
			</td>
		</tr>
		<tr height="2" bgcolor="#a0ccdf">
			<td></td>
		</tr>
		<tr height="100%">
			<td>
				<table border="0" cellspacing="0" cellpadding="0" width="100%" height="100%" style="border-collapse:collapse;">
					<tr>
						<td width="215" id="leftMenu" bgcolor="#666666">
							<iframe id="leftFrame" src="event/main.fhtml" width="100%" height="100%" allowtransparency="true" style="background-color:#EAF2F5" frameborder="0" scrolling="outo"id="leftFrame"></iframe>
						</td>
						<td width="6" valign="center" 
							style="cursor:pointer;background-image:url(${base}/includes/images/middle_bg.jpg); background-repeat:repeat-y" 
							onClick="oclp();">
							<img src="${base}/includes/images/middle_btn.jpg" 
								id="separator" 
								openIcon="${base}/includes/images/middle_btn.jpg"
								closeIcon="${base}/includes/images/middle_btn.jpg"
								opened="true"
								locked="false"
								/>
						</td>
						<td valign="top">
							<table width="100%" border="0" cellpadding="0" cellspacing="0" height="100%" style="margin-left:0px">
								<tr>
									<td><iframe id="mainFrame" src="misc/blank.html" allowtransparency="true" style="background-color:#EAF2F5" width="100%" height="100%" frameborder="0" scrolling="auto" name="mainFrame"></iframe></td>
								</tr>
							</table>
						</td>
					</tr>
				</table>
			</td>
		</tr>
		<tr>
			<td valign="top" id="bottom_view"><iframe src="status.fhtml" width="100%" allowtransparency="true" style="background-color:#EAF2F5" height="22" frameborder="0" scrolling="no" name="statusFrame" title="statusFrame"></iframe></td>
		</tr>
	</table>
	<div style="position:absolute;top:0;left:0;overflow:hidden;width:0;height:0;">
	<object id="sound_player" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"  width="0" height="0" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,28,0">
	  <param name="allowScriptAccess" value="always" />
	  <param name="movie" value="${base}/includes/swf/sound_player.swf" />
	  <param name="quality" value="high" />
	  <embed src="${base}/includes/swf/sound_player.swf" width="0" height="0" quality="high" pluginspage="http://www.adobe.com/shockwave/download/download.cgi?P1_Prod_Version=ShockwaveFlash" allowScriptAccess="always" type="application/x-shockwave-flash" name="sound_player"></embed>
	</object>
	</div>
	
	<@html.dialog id="accountmngdlg" title="帐号管理" width="400">
		<#include "system/usermgr/accountmng.ftl">
	</@html.dialog>
	
	<@dialog id="cachecheckdlg" title="注意" width="300">
		<div class="info_error">您的浏览器开启了页面缓存功能，这会引起某些页面显示不正常。建议您在浏览器的配置中关闭浏览器的缓存功能。<br/><a href="javascript:online_help('common/iecache.html')">点击这里查看帮助</a>
		<br/>
		<input type="checkbox" onclick="Cookie.set('notipcache','true', 90000, '/');"> 下次不再提示
		</div>
	</@dialog>
	<!-- --> 
	<div id="div_notice" style="display:none" class="tip">
		<p style="left:0px;">
			<b class="close" title="关闭" onclick="closeEventNotice()"></b>
			<b id="div_notice_level" class="icon high"></b>
			<span id="div_notice_msg" style="display:block">
			</span>
			<b style="position:absolute;bottom:3;width:100%;text-align:right;padding-right:10px">
				<input id="cb_notice" type="checkbox" onclick="turnEventNotice(this.checked)">禁用
			</b>
		</p>
	</div>
	<form method="post" id="noticeForm" action="${base}/event/notice/list.action" target='eventnotice'>
		<input type='hidden' name='noticeGroupName' value=''>
	</form>
	<@html.dialog id="aboutdlg" title="关于" width="542">
		<#include "help/about.ftl">
	</@html.dialog>
	
	<@html.dialog id="copyrightdlg" title="用户许可协议" width="545">
		<#include "help/copyright.ftl">
	</@html.dialog>
</body>
</html>